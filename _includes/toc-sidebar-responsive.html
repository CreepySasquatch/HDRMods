{% capture tocWorkspace %}
    {% comment %}
        Responsive TOC generator - Desktop sidebar + Mobile collapsible menu
        
        Usage:
            {% include toc-sidebar-responsive.html html=content h_min=2 h_max=4 %}

        Parameters:
            * html         (string) - the HTML of compiled markdown generated by kramdown in Jekyll

        Optional Parameters:
            * h_min         (int)    :   1    - the minimum TOC header level to use
            * h_max         (int)    :   6    - the maximum TOC header level to use
            * skip_no_ids   (bool)   : false  - skip headers that do not have an `id` attribute
            * heading       (string) : 'On This Page' - the heading text for the TOC
    {% endcomment %}

    {% capture newline %}
{% endcapture %}
    {% assign newline = newline | rstrip %}

    {% capture jekyll_toc %}{% endcapture %}
    {% assign skipNoIDs = include.skip_no_ids | default: false %}
    {% assign minHeader = include.h_min | default: 1 %}
    {% assign maxHeader = include.h_max | default: 6 %}
    {% assign nodes = include.html | strip | split: '<h' %}
    {% assign heading = include.heading | default: 'On This Page' %}

    {% assign firstHeader = true %}
    {% assign currLevel = 0 %}
    {% assign lastLevel = 0 %}

    {% for node in nodes %}
        {% if node == "" %}
            {% continue %}
        {% endif %}

        {% assign currLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}

        {% if currLevel < minHeader or currLevel > maxHeader %}
            {% continue %}
        {% endif %}

        {% assign _workspace = node | split: '</h' %}

        {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
        {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
        {% assign htmlID = _idWorkspace[0] %}

        {% assign _classWorkspace = _workspace[0] | split: 'class="' %}
        {% assign _classWorkspace = _classWorkspace[1] | split: '"' %}
        {% assign htmlClass = _classWorkspace[0] %}

        {% if htmlClass contains "no_toc" %}
            {% continue %}
        {% endif %}

        {% if firstHeader %}
            {% assign minHeader = currLevel %}
        {% endif %}

        {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
        {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}
        {% assign header = header | strip_html %}

        {% if htmlID %}
            {% capture listItem %}<a href="#{{ htmlID }}" class="toc-link">{{ header }}</a>{% endcapture %}
        {% elsif skipNoIDs == true %}
            {% continue %}
        {% else %}
            {% capture listItem %}{{ header }}{% endcapture %}
        {% endif %}

        {% if currLevel > lastLevel %}
            {% capture jekyll_toc %}{{ jekyll_toc }}<ul>{% endcapture %}
        {% elsif currLevel < lastLevel %}
            {% assign repeatCount = lastLevel | minus: currLevel %}

            {% for i in (1..repeatCount) %}
                {% capture jekyll_toc %}{{ jekyll_toc }}</li></ul>{% endcapture %}
            {% endfor %}

            {% capture jekyll_toc %}{{ jekyll_toc }}</li>{% endcapture %}
        {% else %}
            {% capture jekyll_toc %}{{ jekyll_toc }}</li>{% endcapture %}
        {% endif %}

        {% capture jekyll_toc %}{{ jekyll_toc }}<li>{{ listItem }}{% endcapture %}

        {% assign lastLevel = currLevel %}
        {% assign firstHeader = false %}
    {% endfor %}

    {% assign repeatCount = minHeader | minus: 1 %}
    {% assign repeatCount = lastLevel | minus: repeatCount %}

    {% for i in (1..repeatCount) %}
        {% capture jekyll_toc %}{{ jekyll_toc }}</li></ul>{% endcapture %}
    {% endfor %}

    {% if jekyll_toc != '' %}
        {% capture jekyll_toc %}<nav class="toc-sidebar" aria-label="Table of contents"><button class="toc-toggle" aria-expanded="false" aria-controls="toc-nav"><span class="toc-sidebar-heading">{{ heading }}</span></button><ul class="toc-sidebar-nav" id="toc-nav">{{ jekyll_toc }}</ul></nav>{% endcapture %}
    {% endif %}
{% endcapture %}{% assign tocWorkspace = '' %}{{ jekyll_toc }}
